<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tonight Planner — 分頁版</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#141a33; --ink:#e9eefc; --muted:#a8b6f5;
      --accent:#7aa2ff; --ok:#2ad1a0; --warn:#ffb02e; --danger:#ff5a78;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0f1430);
         color:var(--ink);font-family:ui-sans-serif,system-ui,"PingFang TC","Noto Sans TC",Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:960px;margin:0 auto;padding:16px}
    h1{margin:0 0 8px}
    h2{margin:0 0 8px;font-size:1.05rem;color:#dfe6ff}
    .sub{color:var(--muted);font-size:.92rem;margin-bottom:12px}
    .panel{background:var(--panel);border:1px solid #223061;border-radius:14px;padding:14px;margin:12px 0}
    label{display:block;margin:8px 0 6px;color:var(--muted);font-size:.95rem}
    textarea,input,button,select{width:100%;padding:12px;border-radius:10px;border:1px solid #2a3767;background:#0e142b;color:var(--ink);font-size:1rem}
    textarea{min-height:160px;resize:vertical}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > *{flex:1 1 240px}
    .btn{background:var(--accent);border:none;font-weight:700;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .btn-ghost{background:transparent;border:1px solid #2a3767}
    .btn-chip{display:inline-block;padding:8px 12px;border-radius:999px;border:1px solid #2a3767;background:#0e142b;margin:6px 6px 0 0;cursor:pointer}
    .btn-chip.active{outline:2px solid var(--accent)}
    .grid{display:grid;gap:10px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-5{grid-template-columns:repeat(5,minmax(0,1fr))}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:.85rem;border:1px solid #2a3767;background:#0e142b;margin:2px 6px 2px 0}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:.95rem}
    th,td{border:1px solid #263565;padding:8px;text-align:center}
    th{background:#18224a}
    input[type="number"]{width:100%;text-align:right}
    .stat{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    .stat .card{flex:1 1 200px;border:1px solid #263565;border-radius:12px;padding:12px;background:#0e142b}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .danger{color:var(--danger)}
    .hint{color:var(--muted);font-size:.9rem}
    .small{font-size:.85rem;color:var(--muted)}
    .center{text-align:center}
    .right{text-align:right}
    .sticky-footer{position:sticky;bottom:0;background:linear-gradient(180deg,#101736,#0b1020);padding:12px;border-top:1px solid #223061}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    /* 分頁導航 */
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .tab{flex:1 1 120px;text-align:center;padding:10px;border-radius:10px;border:1px solid #2a3767;background:#0e142b;color:var(--muted);cursor:pointer}
    .tab.active{background:var(--accent);color:#05122e;border-color:transparent;font-weight:700}
    .page{display:none}
    .page.active{display:block}
    .nav-row{display:flex;justify-content:space-between;gap:10px;margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Tonight Planner</h1>
    <div class="sub">Step 1→4：貼上原始日誌 → 自動抓今晚待辦 → 填時長與排名 → 檢查是否能在上床前完成 → 超時建議移到明天</div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" data-step="1">Step 1｜輸入</div>
      <div class="tab" data-step="2">Step 2｜時間 & Rank</div>
      <div class="tab" data-step="3">Step 3｜可否完成？</div>
      <div class="tab" data-step="4">Step 4｜超時建議</div>
    </div>

    <!-- Page 1 -->
    <div class="page active" id="page1">
      <h2>Step 1｜輸入原始文字 & 今晚時段</h2>
      <div class="panel">
        <label for="raw">貼上你今天的原始資料（可包含多日內容，我會只抽「今天 + #tonighttodolist/#tongihttodolist + Tonight:」）</label>
        <textarea id="raw" placeholder="[2025-10-10\n2:50pm ｜ Tonight: No3 test | status=planned #tonighttodolist dur=30m]\n\n[2025-10-09\n9:10pm ｜ Tonight: something | status=planned #tonighttodolist]"></textarea>

        <div class="row">
          <div>
            <label for="homeTime">預計回到家時間（今天）</label>
            <input id="homeTime" type="time" />
          </div>
          <div>
            <label for="bedTime">上床時間（今天）</label>
            <input id="bedTime" type="time" />
          </div>
        </div>

        <div class="row">
          <button class="btn" id="extractBtn">從 Step1 文字自動抽取今晚任務</button>
          <button class="btn-ghost" id="clearBtn">清空</button>
        </div>

        <div id="detectedWrap" style="margin-top:10px;display:none">
          <div class="hint">已偵測到以下 Tonight 任務（僅列出「今天」且含 #tonighttodolist/#tongihttodolist 的項目）：</div>
          <div id="detected" class="mono"></div>
        </div>
      </div>
      <div class="nav-row">
        <span></span>
        <button class="btn" data-next="2">下一步 → Step 2</button>
      </div>
    </div>

    <!-- Page 2 -->
    <div class="page" id="page2">
      <h2>Step 2｜填每項「預估時長」與「Rank」</h2>
      <div class="panel">
        <div class="hint">點一下快速按鈕即可填入（5m、15m、30m、1h、1.5h、2h）。Rank 以 1–5（1=最高優先）。也可手動輸入。</div>
        <div id="taskList"></div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="recalcBtn">重新計算（Step 3 / Step 4）</button>
        </div>
      </div>
      <div class="nav-row">
        <button class="btn-ghost" data-prev="1">← 返回 Step 1</button>
        <button class="btn" data-next="3">下一步 → Step 3</button>
      </div>
    </div>

    <!-- Page 3 -->
    <div class="page" id="page3">
      <h2>Step 3｜是否能在上床前做完？</h2>
      <div class="panel">
        <div class="stat">
          <div class="card"><div class="small">可用時間（分鐘）</div><div id="availMins" class="mono">—</div></div>
          <div class="card"><div class="small">任務總時長（分鐘）</div><div id="totalMins" class="mono">—</div></div>
          <div class="card"><div class="small">差額（可用−需求）</div><div id="deltaMins" class="mono">—</div></div>
        </div>
        <div id="fitMsg" class="hint" style="margin-top:10px">—</div>
      </div>
      <div class="nav-row">
        <button class="btn-ghost" data-prev="2">← 返回 Step 2</button>
        <button class="btn" data-next="4">下一步 → Step 4</button>
      </div>
    </div>

    <!-- Page 4 -->
    <div class="page" id="page4">
      <h2>Step 4｜若超時：建議改到明天的任務</h2>
      <div class="panel">
        <div id="suggestWrap">
          <div class="hint">當任務總時長超過可用時間時，會依 Rank（數字大＝較不優先）建議移除到明天，直到剛好能符合上床時間。</div>
          <div id="suggestList" class="mono" style="margin-top:8px">—</div>
        </div>
      </div>
      <div class="nav-row">
        <button class="btn-ghost" data-prev="3">← 返回 Step 3</button>
        <span></span>
      </div>
    </div>

    <div class="sticky-footer small">今天日期：<span id="todayStr"></span></div>
  </div>

  <script>
    // —————————— 工具：日期與時間 ——————————
    function pad2(n){ return n.toString().padStart(2,'0'); }
    function getTodayStrLocal(){
      const d = new Date();
      const y = d.getFullYear();
      const m = pad2(d.getMonth()+1);
      const dd = pad2(d.getDate());
      return `${y}-${m}-${dd}`;
    }
    function timeStrToMinutesToday(tStr){
      if(!tStr || !/^\d{2}:\d{2}$/.test(tStr)) return null;
      const [h,m] = tStr.split(':').map(Number);
      return h*60 + m;
    }

    // —————————— 工具：字串解析 Tonight 任務 ——————————
    const TAG_PATTERNS = /#tonighttodolist\b|#tongihttodolist\b/i;

    function parseDurationMinutes(text){
      const patterns = [
        /dur\s*=\s*(\d+)\s*m\b/i,
        /dur\s*=\s*(\d+)\s*min\b/i,
        /dur\s*=\s*(\d+)\s*h\b/i,
        /est\s*=\s*(\d+)\s*m\b/i,
        /est\s*=\s*(\d+)\s*min\b/i,
        /est\s*=\s*(\d+)\s*h\b/i,
        /\b(\d+)\s*min\b/i,
        /\b(\d+)\s*m\b/i,
        /\b(\d+)\s*h\b/i
      ];
      for(const re of patterns){
        const m = text.match(re);
        if(m){
          const val = parseInt(m[1],10);
          if(re.source.includes('\\s*h')) return val*60;
          return val;
        }
      }
      return null;
    }

    function extractTonightItems(raw, todayStr){
      const chunks = [];
      const blockRe = /\[[\s\S]*?\]/g;
      const blocks = raw.match(blockRe);
      if(blocks){ chunks.push(...blocks); }
      else{ raw.split(/\n{2,}/).forEach(s => chunks.push(s)); }

      const results = [];
      for(const chunk of chunks){
        const dateMatch = chunk.match(/(\d{4}-\d{2}-\d{2})/);
        if(!dateMatch) continue;
        const dateStr = dateMatch[1];
        if(dateStr !== todayStr) continue;
        if(!/Tonight\s*:/i.test(chunk)) continue;
        if(!TAG_PATTERNS.test(chunk)) continue;
        const m = chunk.match(/Tonight\s*:\s*([^\|\#\n｜]+)/i);
        if(!m) continue;
        const taskName = m[1].trim();
        const mins = parseDurationMinutes(chunk);
        results.push({ raw: chunk.trim(), name: taskName, minutes: mins, rank: "" });
      }
      return results;
    }

    // —————————— App 狀態 ——————————
    let tasks = [];
    const todayStr = getTodayStrLocal();
    document.getElementById('todayStr').textContent = todayStr;

    (function presetTimes(){
      const now = new Date();
      now.setMinutes(now.getMinutes()+30);
      const hh = pad2(now.getHours());
      const mm = pad2(now.getMinutes());
      document.getElementById('homeTime').value = `${hh}:${mm}`;
      document.getElementById('bedTime').value  = `23:30`;
    })();

    // —————————— 分頁控制 ——————————
    const tabs = Array.from(document.querySelectorAll('.tab'));
    function gotoStep(step){
      tabs.forEach(t=>t.classList.toggle('active', t.dataset.step==step));
      Array.from(document.querySelectorAll('.page')).forEach(p=>p.classList.remove('active'));
      const page = document.getElementById(`page${step}`);
      if(page) page.classList.add('active');
      if(step==3){ renderStats(); }
      if(step==4){ makeSuggestions(); }
    }
    tabs.forEach(t=> t.addEventListener('click', ()=> gotoStep(t.dataset.step)) );
    document.querySelectorAll('[data-next]').forEach(b=> b.addEventListener('click', ()=> gotoStep(b.dataset.next)) );
    document.querySelectorAll('[data-prev]').forEach(b=> b.addEventListener('click', ()=> gotoStep(b.dataset.prev)) );

    // —————————— DOM 連動 ——————————
    const rawEl = document.getElementById('raw');
    const detectedWrap = document.getElementById('detectedWrap');
    const detectedEl = document.getElementById('detected');
    const availEl = document.getElementById('availMins');
    const totalEl = document.getElementById('totalMins');
    const deltaEl = document.getElementById('deltaMins');
    const fitMsgEl = document.getElementById('fitMsg');
    const suggestListEl = document.getElementById('suggestList');

    document.getElementById('clearBtn').addEventListener('click', ()=>{
      rawEl.value = "";
      tasks = [];
      renderDetected([]);
      renderTaskCards();
      renderStats();
      suggestListEl.textContent = "—";
    });

    document.getElementById('extractBtn').addEventListener('click', ()=>{
      tasks = extractTonightItems(rawEl.value || "", todayStr);
      renderDetected(tasks);
      renderTaskCards();
      renderStats();
      suggestListEl.textContent = "—";
      gotoStep(2);
    });

    document.getElementById('recalcBtn').addEventListener('click', ()=>{
      syncFromCards();
      renderStats();
      makeSuggestions();
      gotoStep(3);
    });

    function renderDetected(items){
      if(!items || items.length===0){
        detectedWrap.style.display = "none";
        detectedEl.innerHTML = "";
        return;
      }
      detectedWrap.style.display = "";
      detectedEl.innerHTML = items.map((it,i)=>(`<div class="pill">${i+1}</div><span class="mono">${escapeHtml(it.name)}</span>`)).join("<br/>");
    }

    // —————————— Step 2：卡片樣式（友善輸入） ——————————
    const DUR_PRESETS = [5,15,30,60,90,120]; // (分鐘)
    function durToLabel(m){
      if(m%60===0) return (m/60)+"h";
      if(m>60 && m%30===0) return (m/60).toFixed(1).replace('.0','')+"h";
      return m+"m";
    }

    const taskList = document.getElementById('taskList');
    function renderTaskCards(){
      taskList.innerHTML = '';
      if(!tasks.length){
        taskList.innerHTML = '<div class="center small">（尚無任務，請先在 Step 1 貼上原文並按「自動抽取」）</div>';
        return;
      }
      tasks.forEach((t,idx)=>{
        const card = document.createElement('div');
        card.className = 'panel';
        card.innerHTML = `
          <div class="row">
            <div>
              <label>任務名稱</label>
              <input data-k="name" data-i="${idx}" value="${escapeAttr(t.name ?? '')}" />
            </div>
            <div>
              <label>預估時長（分鐘）</label>
              <input type="number" min="0" step="1" placeholder="(分鐘)" data-k="minutes" data-i="${idx}" value="${t.minutes!=null? t.minutes : ''}" />
              <div class="hint" style="margin-top:6px">快速選擇：</div>
              <div class="grid cols-3" data-durg="${idx}">
                ${DUR_PRESETS.map(m=>`<button type="button" class="btn-chip" data-dur="${m}" data-i="${idx}">${durToLabel(m)}</button>`).join('')}
              </div>
            </div>
            <div>
              <label>Rank（1=最高）</label>
              <select data-k="rank" data-i="${idx}">
                <option value="">未填</option>
                ${[1,2,3,4,5].map(r=>`<option value="${r}" ${Number(t.rank)===r?'selected':''}>${r}</option>`).join('')}
              </select>
              <div class="hint" style="margin-top:6px">或手動輸入：</div>
              <input type="number" min="1" step="1" placeholder="Rank（1–5）」 data-k="rankNum" data-i="${idx}" value="${t.rank ?? ''}" />
            </div>
          </div>
          <details class="small" style="margin-top:8px"><summary>原始標記</summary><div class="mono" style="margin-top:6px">${escapeHtml(t.raw)}</div></details>
        `;
        taskList.appendChild(card);
      });

      // 綁定所有 input/select 變更
      taskList.querySelectorAll('input, select').forEach(inp=>{
        inp.addEventListener('change', ()=>{
          const i = parseInt(inp.dataset.i,10);
          const k = inp.dataset.k;
          let v = inp.value;
          if(k==='minutes' || k==='rank' || k==='rankNum'){
            v = v==="" ? "" : Number(v);
          }
          if(k==='rankNum'){ tasks[i]['rank'] = v; } else { tasks[i][k] = v; }
        });
      });
      // 快速時間按鈕
      taskList.querySelectorAll('.btn-chip[data-dur]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const i = Number(btn.dataset.i);
          const m = Number(btn.dataset.dur);
          tasks[i].minutes = m;
          // 標示 active
          taskList.querySelectorAll(`[data-durg="${i}"] .btn-chip`).forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          // 同步輸入框
          const input = taskList.querySelector(`input[data-k="minutes"][data-i="${i}"]`);
          if(input) input.value = m;
        });
      });
    }

    function syncFromCards(){
      taskList.querySelectorAll('input, select').forEach(inp=>{
        const i = parseInt(inp.dataset.i,10);
        const k = inp.dataset.k;
        let v = inp.value;
        if(k==='minutes' || k==='rank' || k==='rankNum'){
          v = v==="" ? "" : Number(v);
        }
        if(tasks[i]){
          if(k==='rankNum'){ tasks[i]['rank'] = v; }
          else{ tasks[i][k] = v; }
        }
      });
    }

    // —————————— Step 3：計算 & 結論 ——————————
    function renderStats(){
      const home = timeStrToMinutesToday(document.getElementById('homeTime').value);
      const bed  = timeStrToMinutesToday(document.getElementById('bedTime').value);
      let avail = null; let msg = '';
      if(home==null || bed==null){ msg = '請在 Step 1 輸入「回家時間」與「上床時間」。'; }
      else if(bed <= home){ msg = '上床時間需晚於回家時間。'; }
      else{ avail = bed - home; }
      availEl.textContent = (avail==null? '—' : avail);

      const mins = tasks.reduce((sum,t)=>{
        const m = (t.minutes==="" || t.minutes==null) ? 0 : Number(t.minutes);
        return sum + (isFinite(m)? m : 0);
      },0);
      document.getElementById('totalMins').textContent = tasks.length ? mins : '—';

      if(avail==null || !tasks.length){
        deltaEl.textContent = '—';
        fitMsgEl.innerHTML = msg || '—';
        fitMsgEl.className = 'hint';
        return;
      }
      const delta = avail - mins;
      deltaEl.textContent = delta;
      if(delta >= 0){
        fitMsgEl.innerHTML = `<span class="ok">✅ 可以在上床前完成。</span>（還剩 ${delta} 分鐘）`;
        fitMsgEl.className = 'ok';
      }else{
        fitMsgEl.innerHTML = `<span class="danger">⛔ 超時 ${Math.abs(delta)} 分鐘。</span> 請看 Step 4 建議。`;
        fitMsgEl.className = 'danger';
      }
    }

    // —————————— Step 4：建議移到明天 ——————————
    function makeSuggestions(){
      const home = timeStrToMinutesToday(document.getElementById('homeTime').value);
      const bed  = timeStrToMinutesToday(document.getElementById('bedTime').value);
      if(home==null || bed==null || bed<=home || !tasks.length){
        suggestListEl.textContent = '—';
        return;
      }
      const avail = bed - home;
      const total = tasks.reduce((s,t)=> s + (Number(t.minutes)||0), 0);
      if(total <= avail){
        suggestListEl.innerHTML = `<span class="ok">目前不需要移除任務。</span>`;
        return;
      }
      const keepOrder = tasks
        .map((t,i)=>({ i, name:t.name, minutes:Number(t.minutes)||0, rank:(t.rank===''||t.rank==null||!isFinite(Number(t.rank)))?Number.POSITIVE_INFINITY:Number(t.rank) }))
        .sort((a,b)=>{ if(a.rank === b.rank) return a.minutes - b.minutes; return a.rank - b.rank; });

      const remove = []; const keep = []; let keptTime = 0;
      for(const item of keepOrder){
        if(keptTime + item.minutes <= avail){ keptTime += item.minutes; keep.push(item); }
        else{ remove.push(item); }
      }
      const removeTotal = remove.reduce((s,x)=>s+x.minutes,0);
      const keepTotal   = keep.reduce((s,x)=>s+x.minutes,0);
      const overBy = (keepTotal + removeTotal) - avail;
      if(remove.length===0){ suggestListEl.innerHTML = '—'; return; }
      suggestListEl.innerHTML = `
        <div class="warn">建議移到明天（由低優先到高優先）：</div>
        <ul>
          ${remove.map(x=>`<li>${escapeHtml(x.name)}（${x.minutes} 分鐘，Rank=${x.rank===Infinity?'未填':x.rank}）</li>`).join('')}
        </ul>
        <div class="small">
          目前超出：<span class="danger mono">${overBy}</span> 分鐘；移除清單合計：<span class="mono">${removeTotal}</span> 分鐘；保留清單合計：<span class="mono">${keepTotal}</span> 分鐘。
        </div>`;
    }

    // —————————— 安全轉義 ——————————
    function escapeHtml(s){ return (s??'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[c])); }
    function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }
  </script>
</body>
</html>
