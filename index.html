<script>
  // —————————— 工具：日期與時間 ——————————
  function pad2(n){ return n.toString().padStart(2,'0'); }
  function getTodayStrLocal(){
    const d = new Date();
    const y = d.getFullYear();
    const m = pad2(d.getMonth()+1);
    const dd = pad2(d.getDate());
    return `${y}-${m}-${dd}`;
  }
  function timeStrToMinutesToday(tStr){
    if(!tStr || !/^\d{2}:\d{2}$/.test(tStr)) return null;
    const [h,m] = tStr.split(':').map(Number);
    return h*60 + m;
  }
  function minutesToTimeStr(m){
    const hh = Math.floor(m/60)%24; const mm = m%60;
    return `${pad2(hh)}:${pad2(mm)}`;
  }

  // —————————— 工具：字串解析 Tonight 任務（保留原樣） ——————————
  const TAG_PATTERNS = /#tonighttodolist\b|#tongihttodolist\b/i;
  function parseDurationMinutes(text){
    const patterns = [
      /dur\s*=\s*(\d+)\s*m\b/i,
      /dur\s*=\s*(\d+)\s*min\b/i,
      /dur\s*=\s*(\d+)\s*h\b/i,
      /est\s*=\s*(\d+)\s*m\b/i,
      /est\s*=\s*(\d+)\s*min\b/i,
      /est\s*=\s*(\d+)\s*h\b/i,
      /\b(\d+)\s*mins?\b/i,
      /\b(\d+)\s*min\b/i,
      /\b(\d+)\s*m\b/i,
      /\b(\d+(?:\.\d+)?)\s*h(?:ours?)?\b/i
    ];
    for(const re of patterns){
      const m = text.match(re);
      if(m){
        const val = parseFloat(m[1]);
        if(/h/.test(re.source)) return Math.round(val*60);
        return Math.round(val);
      }
    }
    return null;
  }
  function splitTasksInline(titleText){
    const parts = titleText.split(/[,，、]+/).map(s=>s.trim()).filter(Boolean);
    const out = [];
    for(const p of parts){
      const dm = parseDurationMinutes(p);
      if(dm!=null){
        const name = p.replace(/\b\d+(?:\.\d+)?\s*(?:mins?|min|m|h|hours?)\b/i,'').trim();
        out.push({name, minutes:dm});
      }else{
        out.push({name:p, minutes:null});
      }
    }
    return out;
  }
  function extractTonightItems(raw, todayStr){
    const chunks = [];
    const blockRe = /\[[\s\S]*?\]/g;
    const blocks = raw.match(blockRe);
    if(blocks){ chunks.push(...blocks); } else { raw.split(/\n{2,}/).forEach(s => chunks.push(s)); }

    const results = [];
    for(const chunk of chunks){
      const dateMatch = chunk.match(/(\d{4}-\d{2}-\d{2})/);
      if(!dateMatch) continue;
      const dateStr = dateMatch[1];
      if(dateStr !== todayStr) continue;
      if(!/Tonight\s*:/i.test(chunk)) continue;
      if(!TAG_PATTERNS.test(chunk)) continue;

      const m = chunk.match(/Tonight\s*:\s*([^\|\#\n｜]+)/i);
      if(!m) continue;
      const title = m[1].trim();

      const inlineItems = splitTasksInline(title);
      const durInChunk = parseDurationMinutes(chunk);
      let usedDur = false;
      for(const it of inlineItems){
        let minutes = it.minutes;
        if(minutes==null){ minutes = parseDurationMinutes(it.name); }
        if(minutes==null && !usedDur && durInChunk!=null){ minutes = durInChunk; usedDur = true; }
        results.push({
          raw: chunk.trim(),
          name: it.name.replace(/\b\d+(?:\.\d+)?\s*(?:mins?|min|m|h|hours?)\b/i,'').trim(),
          minutes: minutes,
          rank: ""
        });
      }
    }
    return results;
  }

  // —————————— App 狀態 ——————————
  let tasks = [];
  const todayStr = getTodayStrLocal();
  document.getElementById('todayStr').textContent = todayStr;

  // ★ 新增：Step4 用的錨點開始時間（分鐘）。null 時使用 homeTime。
  let anchorStartMin = null;

  // ★ 新增：取得目前應用的開始錨點
  function getAnchorStart(){
    const home = timeStrToMinutesToday(document.getElementById('homeTime').value);
    return (anchorStartMin==null ? home : anchorStartMin) ?? 0;
  }

  // 預設時間
  (function presetTimes(){
    const now = new Date();
    now.setMinutes(now.getMinutes()+30);
    const hh = pad2(now.getHours());
    const mm = pad2(now.getMinutes());
    document.getElementById('homeTime').value = `${hh}:${mm}`;
    document.getElementById('bedTime').value  = `23:30`;
  })();

  // multipage
  const pages = ['page1','page2','page3','page4'];
  function showPage(id){ pages.forEach(pid=>{ document.getElementById(pid).classList.toggle('active', pid===id); }); }

  // Step1 DOM
  const rawEl = document.getElementById('raw');
  const detectedWrap = document.getElementById('detectedWrap');
  const detectedEl = document.getElementById('detected');
  document.getElementById('clearBtn').addEventListener('click', ()=>{
    rawEl.value = ""; tasks = []; renderDetected([]); renderTaskCards(); resetStatsAndSuggest();
    anchorStartMin = null; // ★ 新增：清空時也重置錨點
  });

  document.getElementById('extractAndNext').addEventListener('click', ()=>{
    tasks = extractTonightItems(rawEl.value || "", todayStr);
    renderDetected(tasks);
    renderTaskCards();
    resetStatsAndSuggest();
    anchorStartMin = null; // ★ 新增：重新抽取後，先跟隨 homeTime
    if(!tasks.length){ alert('沒有找到今晚任務，請檢查是否包含「今天日期 + Tonight: + #tonighttodolist/#tongihttodolist」。'); return; }
    showPage('page2');
  });

  function renderDetected(items){
    if(!items || items.length===0){ detectedWrap.style.display = 'none'; detectedEl.innerHTML = ""; return; }
    detectedWrap.style.display = '';
    detectedEl.innerHTML = items.map((it,i)=>(`<div class="pill">${i+1}</div><span class="mono">${escapeHtml(it.name)}</span> ${it.minutes!=null?`<span class="tag-ok">${it.minutes}m</span>`:''}`)).join("<br/>");
  }

  // Step2 友善輸入卡片（保留原樣）
  const DUR_PRESETS = [5,15,30,60,90,120];
  function renderTaskCards(){
    const host = document.getElementById('taskList');
    host.innerHTML = '';
    if(!tasks.length){ host.innerHTML = '<div class="center small">（尚無任務，請先在 Step 1 貼上原文並點「一鍵自動抽取」）</div>'; return; }

    tasks.forEach((t,idx)=>{
      const card = document.createElement('div');
      card.className = 'panel';
      const dur = (t.minutes==null||t.minutes==='')? null : Number(t.minutes);
      const rank = (t.rank==null||t.rank==='')? null : Number(t.rank);
      card.innerHTML = `
        <div class="row">
          <div>
            <label>任務名稱</label>
            <input data-k="name" data-i="${idx}" value="${escapeAttr(t.name ?? '')}" />
          </div>
          <div>
            <label>自訂時長（分鐘，可留空）</label>
            <input type="number" min="0" step="1" placeholder="(分鐘)" data-k="minutes" data-i="${idx}" value="${dur??''}" />
            <div class="small">或點選下列快速按鈕：</div>
            <div class="chips" data-kind="dur" data-i="${idx}">
              ${DUR_PRESETS.map(m=>`<div class="chip ${dur===m?'selected':''}" data-v="${m}">${m===60?'1hr':m===90?'1.5hr':m===120?'2hr':m+'mins'}</div>`).join('')}
            </div>
          </div>
          <div>
            <label>Rank（1=最高，5=最低）</label>
            <div class="rank-group" data-kind="rank" data-i="${idx}">
              ${[1,2,3,4,5].map(r=>`<button type=\"button\" class=\"rank ${rank===r?'selected':''}\" data-v=\"${r}\">${r}</button>`).join('')}
            </div>
          </div>
        </div>
        <div class="small mono" style="margin-top:8px">原始標記：${escapeHtml((t.raw||'').slice(0,160))}${(t.raw||'').length>160?'…':''}</div>
      `;
      host.appendChild(card);
    });

    host.querySelectorAll('.chips .chip').forEach(el=>{
      el.addEventListener('click', ()=>{
        const i = Number(el.parentElement.dataset.i);
        const v = Number(el.dataset.v);
        tasks[i].minutes = v; renderTaskCards();
      });
    });
    host.querySelectorAll('.rank-group .rank').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const i = Number(btn.parentElement.dataset.i);
        const v = Number(btn.dataset.v);
        tasks[i].rank = v; renderTaskCards();
      });
    });
    host.querySelectorAll('input').forEach(inp=>{
      inp.addEventListener('change', ()=>{
        const i = Number(inp.dataset.i);
        const k = inp.dataset.k;
        let v = inp.value;
        if(k==='minutes' || k==='rank'){ v = v===''? '' : Number(v); }
        tasks[i][k] = v;
      });
    });
  }

  document.getElementById('back2').onclick=()=>showPage('page1');
  document.getElementById('toStep3').onclick=()=>{ 
    // ★ 新增：從 Step 2 進入 Step 3 時，錨點跟隨 homeTime
    anchorStartMin = null;
    renderStats(); renderTimetable(); showPage('page3'); 
  };

  // Step3 Timetable 輸出 + 複製（小幅修改以使用錨點）
  const availEl = document.getElementById('availMins');
  const totalEl = document.getElementById('totalMins');
  const deltaEl = document.getElementById('deltaMins');
  const fitMsgEl = document.getElementById('fitMsg');
  const timetableEl = document.getElementById('timetable');

  document.getElementById('back3').onclick=()=>showPage('page2');
  document.getElementById('goStep4').onclick=()=>{ 
    // ★ 新增：首次進入 Step 4 時，把錨點固定為當下 timetable 的第一項開始時間
    const rows = buildSequentialSchedule();
    anchorStartMin = rows.length ? rows[0].start : getAnchorStart();
    renderReorderList(); showPage('page4'); 
  };

  function renderStats(){
    const home = timeStrToMinutesToday(document.getElementById('homeTime').value);
    const bed  = timeStrToMinutesToday(document.getElementById('bedTime').value);
    let avail = null; let msg = '';
    if(home==null || bed==null){ msg = '請在 Step 1 輸入「回家時間」與「上床時間」。'; }
    else if(bed <= home){ msg = '上床時間需晚於回家時間。'; }
    else { avail = bed - home; }
    availEl.textContent = (avail==null? '—' : avail);

    const mins = tasks.reduce((sum,t)=>{ const m = (t.minutes==='' || t.minutes==null) ? 0 : Number(t.minutes); return sum + (isFinite(m)? m : 0); },0);
    totalEl.textContent = tasks.length ? mins : '—';

    if(avail==null || !tasks.length){
      deltaEl.textContent = '—';
      fitMsgEl.textContent = msg || '—';
      fitMsgEl.className = 'hint';
      return;
    }
    const delta = avail - mins; deltaEl.textContent = delta;
    if(delta >= 0){
      fitMsgEl.innerHTML = `<span class="ok">✅ 可以在上床前完成。</span>（還剩 ${delta} 分鐘）`;
      fitMsgEl.className = 'ok';
    }else{
      fitMsgEl.innerHTML = `<span class="danger">⛔ 超時 ${Math.abs(delta)} 分鐘。</span> 可調整順序或時長。`;
      fitMsgEl.className = 'danger';
    }
  }

  // ★ 修改：buildSequentialSchedule 會使用錨點開始時間
  function buildSequentialSchedule(){
    const startAt = getAnchorStart();
    let cur = startAt;
    return tasks.map(t=>{
      const m = Number(t.minutes)||0;
      const item = {name:t.name, start:cur, end:cur+m, minutes:m};
      cur += m; return item;
    });
  }

  function renderTimetable(){
    if(!tasks.length){ timetableEl.textContent = '—'; return; }
    const bed  = timeStrToMinutesToday(document.getElementById('bedTime').value);
    const rows = buildSequentialSchedule();
    let lines = rows.map(r=>`${minutesToTimeStr(r.start)}–${minutesToTimeStr(r.end)}  ${r.name}  (${r.minutes}m)`);
    const endAll = rows.length? rows[rows.length-1].end : null;
    if(endAll!=null && bed!=null && endAll>bed){ lines.push(`\n⚠️ 超過上床時間：${minutesToTimeStr(endAll)} > ${minutesToTimeStr(bed)}`); }
    timetableEl.textContent = lines.join('\n');
  }

  document.getElementById('copyNotes').addEventListener('click', async ()=>{
    const dateStr = new Date().toLocaleString();
    const header = `Tonight Timetable — ${dateStr}`;
    const body = timetableEl.textContent || '';
    const text = `${header}\n\n${body}`;
    try{ await navigator.clipboard.writeText(text); alert('已複製到剪貼簿，請到 iPhone「備忘錄」貼上。'); }
    catch(e){
      const ta = document.createElement('textarea');
      ta.value = text; document.body.appendChild(ta); ta.select(); ta.setSelectionRange(0, ta.value.length);
      const ok = document.execCommand('copy'); document.body.removeChild(ta);
      alert(ok? '已複製到剪貼簿（備援）。' : '複製失敗，請手動全選 Timetable 內容複製。');
    }
  });

  // —————————— Step4 拖曳重排 + 直接改時間段（支援手機 Pointer Events） ——————————
  const reorderList = document.getElementById('reorderList');

  function renderReorderList(){
    reorderList.innerHTML = '';
    // ★ 修改：以錨點時間起排
    let cur = getAnchorStart();
    tasks.forEach((t, idx)=>{
      const li = document.createElement('li');
      li.dataset.index = idx;
      const m = Number(t.minutes)||0; const start=cur; const end=cur+m; cur=end;
      li.innerHTML = `
        <div class="handle" aria-label="拖曳調整">☰</div>
        <div>
          <div class="mono">${escapeHtml(t.name)}</div>
          <div class="small">Rank: ${t.rank===''||t.rank==null? '未填' : t.rank}</div>
        </div>
        <div>
          <label class="small">開始時間</label>
          <input type="time" data-k="start" data-i="${idx}" value="${minutesToTimeStr(start)}" />
        </div>
        <div class="timebox">
          <div style="flex:1">
            <label class="small">時長（分）</label>
            <input type="number" min="0" step="5" data-k="minutes" data-i="${idx}" value="${m}" />
          </div>
          <div class="small mono">結束：<span data-role="end">${minutesToTimeStr(end)}</span></div>
        </div>
      `;
      reorderList.appendChild(li);
    });
    enablePointerReorder();
    validateOverflow();
  }

  function enablePointerReorder(){
    const rows = Array.from(reorderList.children);
    rows.forEach((row)=>{
      const handle = row.querySelector('.handle');
      let startY = 0; let startIndex = 0; let dragging = false;

      // ★ 新增：拖曳開始時記住「目前第一個任務的開始時間」，作為錨點
      function currentFirstStart(){
        const seg = buildSequentialSchedule();
        return seg.length ? seg[0].start : getAnchorStart();
      }

      function onDown(e){
        e.preventDefault();
        dragging = true;
        startY = e.clientY ?? 0;
        startIndex = Array.from(reorderList.children).indexOf(row);
        row.classList.add('ghost');
        // ★ 記錄拖曳前的第一任務開始時間
        row._preDragFirstStart = currentFirstStart();
        window.addEventListener('pointermove', onMove, {passive:false});
        window.addEventListener('pointerup', onUp, {once:true});
      }
      function onMove(e){
        if(!dragging) return;
        e.preventDefault();
        const y = e.clientY ?? 0;
        const elem = document.elementFromPoint(e.clientX || 1, y);
        const li = elem ? elem.closest('li') : null;
        if(li && li.parentElement === reorderList && li !== row){
          const liIndex = Array.from(reorderList.children).indexOf(li);
          if(liIndex > startIndex){
            reorderList.insertBefore(row, li.nextSibling);
          }else{
            reorderList.insertBefore(row, li);
          }
          startIndex = Array.from(reorderList.children).indexOf(row);
        }
      }
      function onUp(){
        if(!dragging) return; dragging = false; row.classList.remove('ghost');
        window.removeEventListener('pointermove', onMove, {passive:false});
        // 依新的 DOM 順序重排 tasks
        const newOrder = Array.from(reorderList.children).map(li=> Number(li.dataset.index));
        tasks = newOrder.map(i=> tasks[i]);
        Array.from(reorderList.children).forEach((li, i)=> li.dataset.index = i);

        // ★ 關鍵：拖曳後將「錨點開始時間」設定為拖曳前第一任務的開始時間
        anchorStartMin = row._preDragFirstStart ?? getAnchorStart();

        renderReorderList();
      }
      handle.addEventListener('pointerdown', onDown);
    });
  }

  // ★ 修改：監聽 Step4 內的時間/時長修改
  reorderList.addEventListener('change', (e)=>{
    const i = Number(e.target.dataset.i);
    const k = e.target.dataset.k;
    if(Number.isNaN(i) || !k) return;

    if(k==='minutes'){
      const v = Math.max(0, Math.round(Number(e.target.value)||0));
      tasks[i].minutes = v;
      // ★ 行為：更新時長只會順延其後任務；錨點不變
      renderReorderList();
      return;
    }

    if(k==='start'){
      const startMin = timeStrToMinutesToday(e.target.value);
      if(startMin==null) return;

      if(i===0){
        // ★ 若修改的是第一個任務的開始時間，就更新錨點
        anchorStartMin = startMin;
        renderReorderList();
        return;
      }

      // ★ 若修改的是中間某項的開始時間：依時間把它插到對應位置（維持錨點），其後自動順延
      const segments = buildSequentialSchedule(); // 以目前錨點計
      let insertPos = tasks.length;
      for(let p=0;p<segments.length;p++){
        if(startMin <= segments[p].start){ insertPos = p; break; }
      }
      const moving = tasks.splice(i,1)[0];
      tasks.splice(insertPos>i? insertPos-1: insertPos, 0, moving);
      renderReorderList();
      return;
    }
  });

  function validateOverflow(){
    const bed  = timeStrToMinutesToday(document.getElementById('bedTime').value);
    const rows = buildSequentialSchedule(); // ★ 使用錨點
    const endAll = rows.length? rows[rows.length-1].end : null;
    const old = reorderList.parentElement.querySelector('.danger');
    if(old) old.remove();
    if(endAll!=null && bed!=null && endAll>bed){
      const over = endAll - bed;
      const warn = document.createElement('div');
      warn.className='danger';
      warn.style.marginTop='8px';
      warn.textContent = `⛔ 超時 ${over} 分鐘，請調整順序或縮短時長。`;
      reorderList.parentElement.appendChild(warn);
    }
  }

  document.getElementById('back4').onclick=()=>showPage('page3');
  document.getElementById('done4').onclick=()=>{ 
    // ★ 回 Step 3 繼續沿用目前錨點（第一任務開始時間）
    renderStats(); renderTimetable(); showPage('page3'); 
  };

  // —————————— 安全轉義 & 初始（保留原樣） ——————————
  function escapeHtml(s){ return (s??"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c])); }
  function escapeAttr(s){ return escapeHtml(s).replace(/\"/g,"&quot;"); }
  function resetStatsAndSuggest(){
    document.getElementById('availMins').textContent = '—';
    document.getElementById('totalMins').textContent = '—';
    document.getElementById('deltaMins').textContent = '—';
    document.getElementById('fitMsg').textContent = '—';
    document.getElementById('timetable').textContent = '—';
  }

  // Dev 測試（保留原樣）
  (function runDevTests(){
    const out = [];
    function ok(name, cond){ out.push(`${cond? '✅ PASS':'❌ FAIL'}  ${name}`); }
    ok('parseDurationMinutes("dur=30m") === 30', parseDurationMinutes('dur=30m')===30);
    ok('parseDurationMinutes("est=2h") === 120', parseDurationMinutes('est=2h')===120);
    const st = splitTasksInline('整雞水 30mins, 運動');
    ok('splitTasksInline 長度=2', st.length===2);
    ok('第一項 minutes=30', st[0].minutes===30);
    ok('第二項 minutes=null', st[1].minutes==null);
    const today = todayStr;
    const sample = `[${today}\n10:00am ｜ Tonight: 測試A 20m, 測試B | status=planned #tonighttodolist]`;
    const items = extractTonightItems(sample, today);
    ok('extractTonightItems 抽到2項', items.length===2);
    ok('第一項=測試A minutes=20', items[0].name.includes('測試A') && items[0].minutes===20);
    ok('第二項=測試B minutes=null', items[1].name.includes('測試B') && items[1].minutes==null);
    document.getElementById('tests').textContent = out.join('\n');
    console.log('[DevTests]', out.join('\n'));
  })();
</script>
