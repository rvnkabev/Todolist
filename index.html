<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tonight Planner — Step1→Step4（Multipage, Timetable）</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#141a33; --ink:#e9eefc; --muted:#a8b6f5;
      --accent:#7aa2ff; --ok:#2ad1a0; --warn:#ffb02e; --danger:#ff5a78;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0f1430);
         color:var(--ink);font-family:ui-sans-serif,system-ui,"PingFang TC","Noto Sans TC",Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:960px;margin:0 auto;padding:20px}
    h1{margin:0 0 12px}
    h2{margin:28px 0 10px;font-size:1.1rem;color:#dfe6ff}
    .panel{background:var(--panel);border:1px solid #223061;border-radius:14px;padding:16px;margin:12px 0}
    label{display:block;margin:8px 0 6px;color:var(--muted);font-size:.95rem}
    textarea,input,button{width:100%;padding:12px;border-radius:10px;border:1px solid #2a3767;background:#0e142b;color:var(--ink);font-size:1rem}
    textarea{min-height:160px;resize:vertical}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > *{flex:1 1 240px}
    .btn{background:var(--accent);border:none;font-weight:700;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:.85rem;border:1px solid #2a3767;background:#0e142b;margin:2px 6px 2px 0}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:.95rem}
    th,td{border:1px solid #263565;padding:8px;text-align:center}
    th{background:#18224a}
    input[type="number"]{width:100%;text-align:right}
    .stat{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    .stat .card{flex:1 1 200px;border:1px solid #263565;border-radius:12px;padding:12px;background:#0e142b}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .danger{color:var(--danger)}
    .hint{color:var(--muted);font-size:.9rem}
    .small{font-size:.85rem;color:var(--muted)}
    .center{text-align:center}
    .right{text-align:right}
    .sticky-footer{position:sticky;bottom:0;background:linear-gradient(180deg,#101736,#0b1020);padding:12px;border-top:1px solid #223061}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    /* multipage */
    .page{display:none}
    .page.active{display:block}

    /* Step4 reorder */
    .draglist{list-style:none;padding:0;margin:0}
    .draglist li{display:grid;grid-template-columns:28px 1fr 120px 140px;gap:8px;align-items:center;padding:10px;border:1px dashed #2a3767;border-radius:12px;margin:8px 0;background:#0e142b}
    .handle{cursor:grab;user-select:none;touch-action:none}
    .handle:active{cursor:grabbing}
    .timebox{display:flex;gap:8px;align-items:center}
    .timebox input[type="time"]{width:auto}
    .ghost{opacity:.4}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Tonight Planner</h1>
    <div class="small">Step1→4：抽任務→填Rank→檢查→可拖曳調整時間</div>

    <section id="page4" class="page active">
      <h2>Step 4｜拖曳調整順序 & 直接改時間段（會自動重排後續）</h2>
      <div class="panel">
        <ul id="reorderList" class="draglist"></ul>
        <div class="row">
          <button id="done4" class="btn">更新 Timetable</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    // 模擬狀態資料
    let tasks = [
      {name:'運動', minutes:30, startOverride:null},
      {name:'整雞水', minutes:45, startOverride:null}
    ];
    document.body.dataset.userEditTime = ''; // 記錄最後手動修改第1項時間的timestamp

    function pad2(n){ return n.toString().padStart(2,'0'); }
    function minutesToTimeStr(m){ const hh=Math.floor(m/60)%24; const mm=m%60; return `${pad2(hh)}:${pad2(mm)}`; }
    function timeStrToMinutesToday(tStr){ if(!tStr||!/^\d{2}:\d{2}$/.test(tStr))return null; const [h,m]=tStr.split(':').map(Number); return h*60+m; }

    // —— render list ——
    const reorderList=document.getElementById('reorderList');
    function renderReorderList(){
      reorderList.innerHTML='';
      tasks.forEach((t,i)=>{
        const start=t.startOverride ?? (19*60+30 + (i===0?0:tasks[i-1].minutes));
        const end=start+(t.minutes||0);
        const li=document.createElement('li');
        li.innerHTML=`
          <div class="handle">☰</div>
          <div><div>${t.name}</div></div>
          <div><label class="small">開始時間</label>
            <input type="time" data-i="${i}" data-k="start" value="${minutesToTimeStr(start)}"></div>
          <div class="timebox">
            <div style="flex:1">
              <label class="small">時長(分)</label>
              <input type="number" data-i="${i}" data-k="minutes" value="${t.minutes}">
            </div>
            <div class="small mono">結束：${minutesToTimeStr(end)}</div>
          </div>`;
        reorderList.appendChild(li);
      });
    }
    renderReorderList();

    // —— 當用戶修改時間或時長 ——
    reorderList.addEventListener('change',e=>{
      const i=Number(e.target.dataset.i);const k=e.target.dataset.k;
      if(k==='minutes'){tasks[i].minutes=Math.max(0,Number(e.target.value)||0);}
      if(k==='start'){
        const v=timeStrToMinutesToday(e.target.value);
        if(v!=null){
          tasks[i].startOverride=v;
          if(i===0){ // 若修改的是第1個任務
            document.body.dataset.userEditTime=Date.now(); // 記錄當前時間戳
          }
        }
      }
      renderReorderList();
    });

    // —— 按下儲存時，判斷是否15秒內有手動修改第一個任務時間 ——
    document.getElementById('done4').onclick=()=>{
      const now=Date.now();
      const lastEdit=Number(document.body.dataset.userEditTime||0);
      const within15s = (now - lastEdit) < 15000;
      if(within15s){
        console.log('✅ 第1個任務開始時間已於15秒內手動修改，將作為預設值保存：', tasks[0].startOverride);
        localStorage.setItem('firstTaskStartOverride', tasks[0].startOverride);
      }else{
        console.log('⏱ 未在15秒內修改，不更新預設');
      }
      alert('Timetable 已更新');
    };

    // —— 若曾儲存過用戶修改的開始時間，則在載入時自動使用它 ——
    window.addEventListener('load',()=>{
      const saved=localStorage.getItem('firstTaskStartOverride');
      if(saved){
        tasks[0].startOverride=Number(saved);
        console.log('📦 已套用保存的第1任務開始時間：', minutesToTimeStr(tasks[0].startOverride));
        renderReorderList();
      }
    });
  </script>
</body>
</html>
